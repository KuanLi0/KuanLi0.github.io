<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>RPC学习 | Hexo</title>
  <meta name="keywords" content="">
  <meta name="description" content="RPC学习 | Hexo">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="XV6文件系统xv6文件系统共分为七层 文件描述符：使用文件系统接口抽象了许多unix资源，简化了程序员的工作。 路径名：提供了分层路径名，并通过递归去来解析它们。 目录：将每一个目录实现为一种特殊的索引节点，其内容是一系列目录项，每一个目录项包含一个文件名和索引号。 索引节点：提供单独的文件，每个文件表示一个索引节点，其中包含唯一的索引号（i-number）和一些保存文件数据的块。 日志：允许更">
<meta property="og:type" content="article">
<meta property="og:title" content="xv6实验九">
<meta property="og:url" content="http://example.com/2025/06/02/xv6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C/xv6%E5%AE%9E%E9%AA%8C%E4%B9%9D/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="XV6文件系统xv6文件系统共分为七层 文件描述符：使用文件系统接口抽象了许多unix资源，简化了程序员的工作。 路径名：提供了分层路径名，并通过递归去来解析它们。 目录：将每一个目录实现为一种特殊的索引节点，其内容是一系列目录项，每一个目录项包含一个文件名和索引号。 索引节点：提供单独的文件，每个文件表示一个索引节点，其中包含唯一的索引号（i-number）和一些保存文件数据的块。 日志：允许更">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/%5Btypora-user-images%5D(..%5Ctypora-user-images)%5Cimage-20250515112755648.png">
<meta property="article:published_time" content="2025-06-02T09:01:28.000Z">
<meta property="article:modified_time" content="2025-06-02T09:02:12.311Z">
<meta property="article:author" content="Li Kuan">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/%5Btypora-user-images%5D(..%5Ctypora-user-images)%5Cimage-20250515112755648.png">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/darcula.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 7.3.0"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/avatar.jpg"/>
</a>
<div class="author">
    <span>Li Kuan</span>
</div>

<div class="icon">
    
        
    
        
            <a title="github"
               href="https://github.com/KuanLi0/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="facebook"
               href="11"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-facebook"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="twitter"
               href="11"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-twitter"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="linkedin"
               href="11"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-linkedin"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="instagram"
               href="11"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-instagram"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="reddit"
               href="11"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-reddit"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="weibo"
               href="11"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-weibo"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="jianshu"
               href="11"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-jianshu"></use>
                    </svg>
                
            </a>
        
    
        
    
        
    
        
    
        
    
        
            <a title="email"
               href="mailto:likuan202302@163.com"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-email"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="qq"
               href="http://wpa.qq.com/msgrd?v=3&uin=2681123650@qq.com&site=qq&menu=yes"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-qq"></use>
                    </svg>
                
            </a>
        
    
        
    
        
    
</div>





<ul>
    <li>
        <div class="all active" data-rel="All">All
            
                <small>(14)</small>
            
        </div>
    </li>
    
        
            
                
    <li>
        <div data-rel="LLVM">
            
            LLVM
            <small>(2)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="操作系统">
            
            操作系统
            <small>(9)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="RUST学习">
            
            RUST学习
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="其它">
            
            其它
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
            
    </div>
    <div>
        
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="14">

<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        Links
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">叶落阁</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="search shortcut key i"></i>
            <div class="right-title">All</div>
            <i class="iconfont icon-file-tree" data-title="switch to outline view shortcut key w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="return"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="case sensitive"></i>
            <i class="iconfont icon-tag" data-title="label"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">outline</div>
            <i class="iconfont icon-list" data-title="switch to article list"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        
        <a  class="All 操作系统 "
           href="/2025/06/02/xv6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C/xv6%E5%AE%9E%E9%AA%8C%E4%B9%9D/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="xv6实验九">xv6实验九</span>
            <span class="post-date" title="2025-06-02 17:01:28">2025/06/02</span>
        </a>
        
        
        <a  class="All 操作系统 "
           href="/2025/06/02/xv6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C/xv6%E5%AE%9E%E9%AA%8C%E5%85%AB/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="xv6实验八">xv6实验八</span>
            <span class="post-date" title="2025-06-02 17:00:54">2025/06/02</span>
        </a>
        
        
        <a  class="All 操作系统 "
           href="/2025/06/02/xv6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C/xv6%E5%AE%9E%E9%AA%8C%E4%B8%83/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="xv6实验七">xv6实验七</span>
            <span class="post-date" title="2025-06-02 16:59:12">2025/06/02</span>
        </a>
        
        
        <a  class="All "
           href="/2025/06/02/xv6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C/xv6%E5%AE%9E%E9%AA%8C%E5%85%AD/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="xv6实验六">xv6实验六</span>
            <span class="post-date" title="2025-06-02 16:58:27">2025/06/02</span>
        </a>
        
        
        <a  class="All 操作系统 "
           href="/2025/06/02/xv6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C/xv6%E5%AE%9E%E9%AA%8C%E4%BA%94/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="xv6实验五">xv6实验五</span>
            <span class="post-date" title="2025-06-02 16:57:55">2025/06/02</span>
        </a>
        
        
        <a  class="All LLVM "
           href="/2025/04/17/llvm-ssa/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="llvm_ssa">llvm_ssa</span>
            <span class="post-date" title="2025-04-17 21:28:33">2025/04/17</span>
        </a>
        
        
        <a  class="All LLVM "
           href="/2025/03/17/llvm%E5%90%8E%E7%AB%AF/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="llvm后端">llvm后端</span>
            <span class="post-date" title="2025-03-17 21:30:13">2025/03/17</span>
        </a>
        
        
        <a  class="All 其它 "
           href="/2025/03/17/RPC/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="RPC学习">RPC学习</span>
            <span class="post-date" title="2025-03-17 21:21:16">2025/03/17</span>
        </a>
        
        
        <a  class="All 操作系统 "
           href="/2025/03/09/xv6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C/xv6%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="xv6源码剖析">xv6源码剖析</span>
            <span class="post-date" title="2025-03-09 14:53:18">2025/03/09</span>
        </a>
        
        
        <a  class="All RUST学习 "
           href="/2025/02/17/RUST/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="RUST基础">RUST基础</span>
            <span class="post-date" title="2025-02-17 21:23:48">2025/02/17</span>
        </a>
        
        
        <a  class="All 操作系统 "
           href="/2025/01/20/xv6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C/xv6%E5%AE%9E%E9%AA%8C%E5%9B%9B/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="xv6实验四">xv6实验四</span>
            <span class="post-date" title="2025-01-20 16:57:02">2025/01/20</span>
        </a>
        
        
        <a  class="All 操作系统 "
           href="/2025/01/10/xv6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C/xv6%E5%AE%9E%E9%AA%8C%E4%B8%89/xv6%E5%AE%9E%E9%AA%8C%E4%B8%89/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="xv6实验三">xv6实验三</span>
            <span class="post-date" title="2025-01-10 16:42:38">2025/01/10</span>
        </a>
        
        
        <a  class="All 操作系统 "
           href="/2025/01/06/xv6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C/xv6%E5%AE%9E%E9%AA%8C%E4%BA%8C/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="xv6实验二">xv6实验二</span>
            <span class="post-date" title="2025-01-06 12:39:09">2025/01/06</span>
        </a>
        
        
        <a  class="All 操作系统 "
           href="/2025/01/02/xv6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C/xv6%E5%AE%9E%E9%AA%8C%E4%B8%80/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="xv6实验一">xv6实验一</span>
            <span class="post-date" title="2025-01-02 16:36:51">2025/01/02</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="Toggle full screen shortcut key s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-RPC" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">RPC学习</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="其它">其它</a>
            
        </span>
        
        
    </div>
    <div class="article-meta">
        
            Created At : <time class="date" title='Updated At: 2025-06-17 21:23:37'>2025-03-17 21:21</time>
        
    </div>
    <div class="article-meta">
        
        
        <span id="busuanzi_container_page_pv">
            Views 👀 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81%E5%AE%9A%E4%B9%89"><span class="toc-text">1、定义</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81RPC%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-text">2、RPC的实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1%E3%80%81%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-text">2.1、实现思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A1%A8%E7%A4%BA"><span class="toc-text">2.2数据的表示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3%E6%95%B0%E6%8D%AE%E7%9A%84%E4%BC%A0%E9%80%92"><span class="toc-text">2.3数据的传递</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CAP%E7%90%86%E8%AE%BA"><span class="toc-text">CAP理论</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#C-consistency-%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-text">C(consistency)一致性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#A%EF%BC%88Availability%EF%BC%89%E5%8F%AF%E7%94%A8%E6%80%A7"><span class="toc-text">A（Availability）可用性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#P%EF%BC%88Partition-tolerance%EF%BC%89%E5%88%86%E5%8C%BA%E5%AE%B9%E9%94%99%E6%80%A7"><span class="toc-text">P（Partition tolerance）分区容错性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cap%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-text">cap的选择</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9-CAP-%E7%9A%84%E5%B8%B8%E8%A7%81%E8%AF%AF%E8%A7%A3"><span class="toc-text">对 CAP 的常见误解</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PACELC%E7%90%86%E8%AE%BA"><span class="toc-text">PACELC理论</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#base%E7%90%86%E8%AE%BA"><span class="toc-text">base理论</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#base-%E5%9F%BA%E6%9C%AC%E5%8F%AF%E7%94%A8"><span class="toc-text">base-基本可用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#base-%E8%BD%AF%E7%8A%B6%E6%80%81"><span class="toc-text">base-软状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#base-%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-text">base-最终一致性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CAP-%E4%B8%8E-BASE-%E5%85%B3%E7%B3%BB"><span class="toc-text">CAP 与 BASE 关系</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NWR%E7%90%86%E8%AE%BA"><span class="toc-text">NWR理论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-NWR%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0"><span class="toc-text">1. NWR的核心参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%B8%80%E8%87%B4%E6%80%A7%E4%BF%9D%E8%AF%81%E7%9A%84%E6%A0%B8%E5%BF%83%E8%A7%84%E5%88%99"><span class="toc-text">2. 一致性保证的核心规则</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%E7%90%86%E8%AE%BA"><span class="toc-text">一致性理论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%88Strong-Consistency%EF%BC%89"><span class="toc-text">一、强一致性（Strong Consistency）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%AE%9A%E4%B9%89"><span class="toc-text">核心定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%BC%B1%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%88Weak-Consistency%EF%BC%89"><span class="toc-text">二、弱一致性（Weak Consistency）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%AE%9A%E4%B9%89-1"><span class="toc-text">核心定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%88Eventual-Consistency%EF%BC%89"><span class="toc-text">1. 最终一致性（Eventual Consistency）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%9B%A0%E6%9E%9C%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%88Causal-Consistency%EF%BC%89"><span class="toc-text">2. 因果一致性（Causal Consistency）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%BC%9A%E8%AF%9D%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%88Session-Consistency%EF%BC%89"><span class="toc-text">3. 会话一致性（Session Consistency）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%8D%95%E8%B0%83%E8%AF%BB-%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%88Monotonic-Consistency%EF%BC%89"><span class="toc-text">4. 单调读&#x2F;写一致性（Monotonic Consistency）</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Raft%E7%AE%97%E6%B3%95"><span class="toc-text">Raft算法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">一、核心概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E9%A2%86%E5%AF%BC%E8%80%85%E9%80%89%E4%B8%BE"><span class="toc-text">二、领导者选举</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6"><span class="toc-text">1. 触发条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%80%89%E4%B8%BE%E6%B5%81%E7%A8%8B"><span class="toc-text">2. 选举流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%81%BF%E5%85%8D%E9%80%89%E4%B8%BE%E5%86%B2%E7%AA%81"><span class="toc-text">3. 避免选举冲突</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%97%A5%E5%BF%97%E5%A4%8D%E5%88%B6"><span class="toc-text">三、日志复制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%97%A5%E5%BF%97%E7%BB%93%E6%9E%84"><span class="toc-text">1. 日志结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%97%A5%E5%BF%97%E5%A4%8D%E5%88%B6%E6%B5%81%E7%A8%8B"><span class="toc-text">2. 日志复制流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%97%A5%E5%BF%97%E4%B8%80%E8%87%B4%E6%80%A7%E4%BF%9D%E8%AF%81"><span class="toc-text">3. 日志一致性保证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%AE%89%E5%85%A8%E6%80%A7"><span class="toc-text">四、安全性</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%80%89%E4%B8%BE%E9%99%90%E5%88%B6%EF%BC%88Election-Restriction%EF%BC%89"><span class="toc-text">1. 选举限制（Election Restriction）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%8F%90%E4%BA%A4%E8%A7%84%E5%88%99%EF%BC%88Commitment-Rules%EF%BC%89"><span class="toc-text">2. 提交规则（Commitment Rules）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%84%91%E8%A3%82%EF%BC%88Split-Brain%EF%BC%89%E5%A4%84%E7%90%86"><span class="toc-text">3. 脑裂（Split-Brain）处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E7%A4%BA%E4%BE%8B"><span class="toc-text">五、示例</span></a></li></ol></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="1、定义"><a href="#1、定义" class="headerlink" title="1、定义"></a>1、定义</h1><p>RPC（Remote Procedure Call）是一种<strong>远程过程调用协议</strong>，它允许一个程序调用另一个程序中的函数或方法，而无需了解底层的网络细节。因此RPC的出现使得分布式系统中的各个组件之间的通信变得更加简单、高效和可靠。</p>
<h2 id="2、RPC的实现"><a href="#2、RPC的实现" class="headerlink" title="2、RPC的实现"></a>2、RPC的实现</h2><h2 id="2-1、实现思路"><a href="#2-1、实现思路" class="headerlink" title="2.1、实现思路"></a>2.1、实现思路</h2><p><img src="https://i-blog.csdnimg.cn/direct/e4d7c14dc2d640d1888ce86825530eea.png#pic_center" alt="img"></p>
<p>由此图来看，可以分为一下步骤</p>
<ul>
<li>定义接口和数据类型：首先需要定义接口和数据类型，包括接口方法名，参数类型没返回值类型等。这些定义通常使用IDL语言来描述，以便不用语言之间的调用和序列化。</li>
<li>生成代码：根据接口和数据类型的定义，生成客户端和服务端的代码。这些代码通常包括序列化和反序列化方法，网络传输方法等，以便于客户端和服务器端进行数据交换和通信。</li>
<li>实现服务器端：在服务器端实现接口方法，根据客户端请求进行处理，并将处理结果返回客户端。</li>
<li>实现客户端：在客户端调用远程接口方法，将参数序列化并通过网络发送给服务端，然后等待服务器返回处理结果，并将结果反序列化传递给调用方。</li>
<li>集成框架：将生成的代码和实现的服务器端、客户端集成到RPC框架中，并提供相应的API工具。</li>
<li>测试和优化</li>
</ul>
<h2 id="2-2数据的表示"><a href="#2-2数据的表示" class="headerlink" title="2.2数据的表示"></a>2.2数据的表示</h2><p>对于如何表示数据的做法是将交互双方所涉及的数据转换为某种事先约定好的中立数据流格式来进行传输，将数据流转换回不同语言中对应的数据类型来进行使用，而这就是序列化协议的初衷，除此之外设计一个好的序列化协议还有以下几个作用：</p>
<ul>
<li>跨语言和跨平台： 在分布式系统中，不同计算机可能使用不同的编程语言和操作系统，因此需要一种通用的数据格式，以便于跨语言和跨平台进行数据传输和交互。序列化协议可以将数据转换为一种通用的格式，使得不同计算机之间可以正确地对数据进行编码和解码。</li>
<li>数据压缩： 在网络传输过程中，数据的大小会影响网络带宽和传输速度，因此需要对数据进行压缩。序列化协议可以将数据压缩为更小的二进制格式，从而减少网络传输的数据量，提高网络传输效率。</li>
<li>数据安全： 在网络传输过程中，数据可能会被篡改或窃取，因此需要对数据进行加密和解密。序列化协议可以将数据转换为二进制格式，并进行加密和解密操作，从而保证数据的安全性和完整性。</li>
<li>数据可读性： 在调试和排错过程中，需要查看网络传输的数据内容，以便于定位问题。序列化协议可以将数据转换为文本格式，使得数据更易于读取和理解。</li>
</ul>
<h2 id="2-3数据的传递"><a href="#2-3数据的传递" class="headerlink" title="2.3数据的传递"></a>2.3数据的传递</h2><p>数据的传输并不是简单的约定好数据格式进行序列化反序列化就行，还需要考虑数据传输时需要的额外的信息譬如异常、超时、安全、认证、授权、事务，等等，都可能产生双方需要交换信息的需求,对这一类的行为则被称作Wire Protocol。而常见的Wire Protocol协议主要有：</p>
<ul>
<li>两端都是http endpoint可以直接HTTP</li>
<li>Java RMI 的Java Remote Message Protocol（JRMP，也支持RMI-IIOP）</li>
<li>CORBA 的Internet Inter ORB Protocol（IIOP，是 GIOP 协议在 IP 协议上的实现版本）</li>
<li>DDS 的Real Time Publish Subscribe Protocol（RTPS）</li>
<li>Web Service 的Simple Object Access Protocol（SOAP）</li>
</ul>
<h1 id="CAP理论"><a href="#CAP理论" class="headerlink" title="CAP理论"></a>CAP理论</h1><p>一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和分区容错性（Partition tolerance）这三项中的两项。</p>
<h2 id="C-consistency-一致性"><a href="#C-consistency-一致性" class="headerlink" title="C(consistency)一致性"></a>C(consistency)一致性</h2><p>一致性指的是在分布式系统中，<strong>所有节点在同一时刻看到的数据是完全相同的</strong>。任何读操作都能立即获得<strong>最新写入的数据</strong>，或者返回明确的错误。系统的表现就像只有一个数据副本一样，无论客户端从哪个节点访问数据，结果都一致。</p>
<p><img src="C:\Users\likuan\AppData\Roaming\Typora\typora-user-images\image-20250408162940695.png" alt="image-20250408162940695"></p>
<h2 id="A（Availability）可用性"><a href="#A（Availability）可用性" class="headerlink" title="A（Availability）可用性"></a>A（Availability）可用性</h2><p>可用性在 CAP 里就是对结果的要求。它要求系统内的节点们接收到了无论是写请求还是读请求，都要能处理并给回响应结果。只是它有两点必须满足的条件：</p>
<p>条件 1：返回结果必须在合理的时间以内，这个合理的时间是根据业务来定的。</p>
<p>条件 2：需要系统内能正常接收请求的所有节点都返回结果。</p>
<p>要保证A就意味着可能要失去C，读请求可能会读取到旧值。</p>
<h2 id="P（Partition-tolerance）分区容错性"><a href="#P（Partition-tolerance）分区容错性" class="headerlink" title="P（Partition tolerance）分区容错性"></a>P（Partition tolerance）分区容错性</h2><p>分布式的存储系统会有很多的节点，这些节点都是通过网络进行通信。而网络是不可靠的，当节点和节点之间的通信出现了问题，此时，就称当前的分布式存储系统出现了分区。比如，我们的分布式存储系统有 A、B 两个节点。那么，当 A、B 之间由于可能路由器、交换机等底层网络设备出现了故障，A 和 B 通信出现了问题，但是 A、B 依然都在运行，都在对外提供服务。这时候，就说 A 和 B 发生了分区。</p>
<h2 id="cap的选择"><a href="#cap的选择" class="headerlink" title="cap的选择"></a>cap的选择</h2><p>在分布式系统内，P 是必然的发生的，不选 P，一旦发生分区错误，整个分布式系统就完全无法使用了，这是不符合实际需要的。</p>
<ul>
<li><p><strong>需要A的场景</strong>：</p>
<ul>
<li>对服务连续性要求高的场景（如电商商品展示、社交媒体动态）。</li>
<li>允许短暂数据不一致但必须避免服务中断的系统（如CDN缓存、实时评论系统）</li>
</ul>
</li>
<li><p><strong>需要C的场景</strong>：金融交易、库存管理等对数据准确性要求极高的系统（如ZooKeeper、HBase等CP系统）。</p>
</li>
</ul>
<h2 id="对-CAP-的常见误解"><a href="#对-CAP-的常见误解" class="headerlink" title="对 CAP 的常见误解"></a>对 CAP 的常见误解</h2><ul>
<li><p><strong>分布式系统因为 CAP 定理放弃了 C 或者 A 中的其中一个</strong>：当没有出现分区问题的时候，系统就应该有完美的数据一致性和可用性。</p>
</li>
<li><p><strong>C 和 A 之间的选择是针对整个分布式系统的，只能整体考虑 C 和 A 之间的选择</strong>：根据事件的类型，去做不同的选择。这个理解也是不对的。当分区发生的时候，其实对一致性和可用性的抉择是局部性的，而不是针对整个系统的。可能是在一些子系统做一些抉择，甚至很可能只需要对某个事件或者数据，做一致性和可用性的抉择而已。比如，当我们做一套支付系统的时候，会员的财务相关像账户余额，账务流水是必须强一致性的。这时候，你就要考虑选 C。但是，会员的名字，会员的支付设置就不必考虑强一致性，可以选择可用性 A。</p>
</li>
<li><p><strong>CAP 的三个特性只有是和否两种极端选择，而不是一个范围</strong>：CAP 理论的三种特性不是 Boolean 类型的，不是一致和不一致，可用和不可用，分区和没分区的这类二选一的选项。而是这三种特性都是范围类型。</p>
<p>拿可用性来说，就像我从银行取钱。当我目的是派发压岁钱的时候，我很可能就想全要新票子，但是，新票子很可能就还得多一个步骤，就是需要拿旧票子去换一些新票，此时，我可以多等会儿，能拿到新票子就好。而当我的目的就是做生活花销的时候，票子是新是旧，我根本不那么关心，快点拿到钱就行。这就是可用性的范围需求之一，对时延性的要求。再比如，分区容错则由于探测机制的问题，可能还得各节点搞投票去协商分区是否存在，当某一台机器出现了问题，可能不影响业务的话，就会被机器投票认为分区不存在。然后一直等到多数机器出现了问题，才会投票确认出现了分区问题。这就好像新冠疫情，还会分低、中、高风险区呢，不是一出现通信故障就都被逻辑认定为分区问题。</p>
</li>
</ul>
<h1 id="PACELC理论"><a href="#PACELC理论" class="headerlink" title="PACELC理论"></a>PACELC理论</h1><p>PACELC理论是基于CAP理论推演而来的，一般的分布式系统要求必须有分区容错性，只能在C和A中进行取舍，但是大部分的系统通常是不会分区的，在这种情况下，系统只需要关注请求延迟和数据一致的问题，即 Latency（延迟）与 Consistency（一致性）。PACELC中的E代表else，表示如果P发生的时候就用CAP，如果不发生(else),那么就变为延迟和一致性的平衡问题。</p>
<h1 id="base理论"><a href="#base理论" class="headerlink" title="base理论"></a>base理论</h1><p>BASE理论是由eBay架构师提出的。BASE是对CAP中一致性和可用性权衡的结果，其来源于对大规模互联网分布式系统实践的总结，是基于CAP定律逐步演化而来。其核心思想是即使无法做到强一致性，但每个应用都可以根据自身业务特点，才用适当的方式来使系统打到最终一致性。BASE是“Basically Available, Soft state, Eventually consistent(基本可用、软状态、最终一致性)”的首字母缩写。</p>
<h2 id="base-基本可用"><a href="#base-基本可用" class="headerlink" title="base-基本可用"></a>base-基本可用</h2><p>分布式系统在出现不可预知故障的时候，允许损失部分可用性</p>
<h2 id="base-软状态"><a href="#base-软状态" class="headerlink" title="base-软状态"></a>base-软状态</h2><p>软状态也称为弱状态，和硬状态相对，是指允许系统中的数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程<strong>存在延时</strong>。</p>
<h2 id="base-最终一致性"><a href="#base-最终一致性" class="headerlink" title="base-最终一致性"></a>base-最终一致性</h2><ol>
<li>最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性</li>
</ol>
<h2 id="CAP-与-BASE-关系"><a href="#CAP-与-BASE-关系" class="headerlink" title="CAP 与 BASE 关系"></a>CAP 与 BASE 关系</h2><p>BASE是对CAP中一致性和可用性权衡的结果，其来源于对大规模互联网系统分布式实践的结论，是基于CAP定理逐步演化而来的，其核心思想是即使无法做到强一致性（Strong consistency），更具体地说，<strong>是对 CAP 中 AP 方案的一个补充</strong>。其基本思路就是：通过业务，牺牲强一致性而获得可用性，并允许数据在一段时间内是不一致的，但是最终达到一致性状态。</p>
<h1 id="NWR理论"><a href="#NWR理论" class="headerlink" title="NWR理论"></a>NWR理论</h1><h3 id="1-NWR的核心参数"><a href="#1-NWR的核心参数" class="headerlink" title="1. NWR的核心参数"></a><strong>1. NWR的核心参数</strong></h3><ul>
<li><strong>N（副本数量）</strong>：数据在分布式系统中的副本总数。例如，N&#x3D;3表示数据有3个副本存储在不同节点上，以提高容错性。</li>
<li><strong>W（写入成功的最小副本数）</strong>：一次写操作需至少成功写入W个副本才被视为完成。例如，W&#x3D;2表示写入2个副本即返回成功。</li>
<li><strong>R（读取成功的最小副本数）</strong>：一次读操作需至少成功读取R个副本的数据才返回结果。例如，R&#x3D;2表示需读取2个副本的数据。</li>
</ul>
<h3 id="2-一致性保证的核心规则"><a href="#2-一致性保证的核心规则" class="headerlink" title="2. 一致性保证的核心规则"></a><strong>2. 一致性保证的核心规则</strong></h3><p>当 <strong>W + R &gt; N</strong> 时，系统可保证<strong>强一致性</strong>。此时，写操作和读操作的副本集合必然存在交集，确保至少有一个最新版本的数据被读取到4512。<br>例如，N&#x3D;3、W&#x3D;2、R&#x3D;2时，每次读操作至少能读取到一个已成功写入的最新副本，从而避免读取旧数据612。</p>
<p>若 <strong>W + R ≤ N</strong>，则系统仅能保证<strong>最终一致性</strong>，可能存在短暂的数据不一致窗口。</p>
<h1 id="一致性理论"><a href="#一致性理论" class="headerlink" title="一致性理论"></a>一致性理论</h1><p>分布式系统中的一致性理论是保障数据可靠性和系统可用性的核心框架，其本质是在多节点环境中协调数据状态，确保系统满足业务需求。不同的一致性模型定义了数据同步的严格程度和系统行为的边界，以下是分布式系统中主要的一致性模型及其应用场景的详细解析：</p>
<h3 id="一、强一致性（Strong-Consistency）"><a href="#一、强一致性（Strong-Consistency）" class="headerlink" title="一、强一致性（Strong Consistency）"></a><strong>一、强一致性（Strong Consistency）</strong></h3><p>强一致性也不一定能保证数据是最新的只能保证数据是一致的。</p>
<h4 id="核心定义"><a href="#核心定义" class="headerlink" title="核心定义"></a><strong>核心定义</strong></h4><p>系统保证<strong>所有节点在同一时刻看到的数据完全一致</strong>，表现为：</p>
<ul>
<li><strong>线性一致性（Linearizability）</strong>：所有操作（读写）按全局时序排列，如同在单机系统上执行。</li>
<li><strong>顺序一致性（Sequential Consistency）</strong>：操作在全局顺序上保持一致，但允许不同客户端看到不同的执行顺序。</li>
</ul>
<h3 id="二、弱一致性（Weak-Consistency）"><a href="#二、弱一致性（Weak-Consistency）" class="headerlink" title="二、弱一致性（Weak Consistency）"></a><strong>二、弱一致性（Weak Consistency）</strong></h3><h4 id="核心定义-1"><a href="#核心定义-1" class="headerlink" title="核心定义"></a><strong>核心定义</strong></h4><p>系统<strong>不保证数据实时一致</strong>，允许短暂的不一致窗口，但最终趋于一致。根据业务需求可细分为多种模型：</p>
<h4 id="1-最终一致性（Eventual-Consistency）"><a href="#1-最终一致性（Eventual-Consistency）" class="headerlink" title="1. 最终一致性（Eventual Consistency）"></a><strong>1. 最终一致性（Eventual Consistency）</strong></h4><ul>
<li><strong>定义</strong>：没有新写入时，所有副本最终同步一致。</li>
<li><strong>实现机制</strong>：<ul>
<li><strong>异步复制</strong>：写入主节点后异步传播到从节点。</li>
<li><strong>Gossip协议</strong>：节点间随机交换数据（如Cassandra）。</li>
<li><strong>反熵（Anti-Entropy）</strong>：定期校验并修复数据差异。</li>
</ul>
</li>
<li><strong>典型场景</strong>：<ul>
<li><strong>社交媒体动态</strong>：用户短暂看到旧帖子不影响体验。</li>
<li><strong>CDN缓存</strong>：缓存节点延迟同步源站数据。</li>
<li><strong>物联网数据采集</strong>：设备上报数据允许延迟汇总。</li>
</ul>
</li>
</ul>
<h4 id="2-因果一致性（Causal-Consistency）"><a href="#2-因果一致性（Causal-Consistency）" class="headerlink" title="2. 因果一致性（Causal Consistency）"></a><strong>2. 因果一致性（Causal Consistency）</strong></h4><ul>
<li><strong>定义</strong>：存在因果关系的操作必须按顺序生效，无因果关系的操作可并发。</li>
<li><strong>实现方式</strong>：<ul>
<li><strong>逻辑时钟（Logical Clocks）</strong>：通过Lamport时间戳或向量时钟追踪因果关系。</li>
<li><strong>依赖追踪</strong>：记录操作间的依赖链（如Riak的CRDTs）。</li>
</ul>
</li>
<li><strong>典型场景</strong>：<ul>
<li><strong>社交评论系统</strong>：回复必须出现在原帖之后。</li>
<li><strong>协同编辑工具</strong>（如Google Docs）：用户操作需保留因果顺序。</li>
</ul>
</li>
</ul>
<h4 id="3-会话一致性（Session-Consistency）"><a href="#3-会话一致性（Session-Consistency）" class="headerlink" title="3. 会话一致性（Session Consistency）"></a><strong>3. 会话一致性（Session Consistency）</strong></h4><ul>
<li><strong>定义</strong>：同一会话（用户连接）内保证读写一致性，跨会话可能不一致。</li>
<li><strong>实现方式</strong>：<ul>
<li><strong>粘性会话（Sticky Session）</strong>：用户请求固定路由到同一节点。</li>
<li><strong>版本号追踪</strong>：会话内携带数据版本号（如DynamoDB）。</li>
</ul>
</li>
<li><strong>典型场景</strong>：<ul>
<li><strong>购物车系统</strong>：用户在一个会话内看到自己的实时操作。</li>
<li><strong>游戏状态同步</strong>：玩家视角内的数据实时一致。</li>
</ul>
</li>
</ul>
<h4 id="4-单调读-写一致性（Monotonic-Consistency）"><a href="#4-单调读-写一致性（Monotonic-Consistency）" class="headerlink" title="4. 单调读&#x2F;写一致性（Monotonic Consistency）"></a><strong>4. 单调读&#x2F;写一致性（Monotonic Consistency）</strong></h4><ul>
<li><strong>单调读</strong>：用户一旦读到某数据的新版本，后续不会读到更旧版本。</li>
<li><strong>单调写</strong>：同一用户的写操作按顺序生效（如用户先改密码再登录）。</li>
<li><strong>典型系统</strong>：DNS系统通过TTL过期机制实现单调读。</li>
</ul>
<h1 id="Raft算法"><a href="#Raft算法" class="headerlink" title="Raft算法"></a>Raft算法</h1><p>Raft是一种为分布式系统设计的共识算法，旨在简化理解和实现，同时保持与Paxos相同的容错能力。其核心思想是将共识问题分解为三个关键子问题：<strong>领导者选举（Leader Election）</strong>、**日志复制（Log Replication）**和**安全性（Safety）**。以下是Raft算法的详细解析：</p>
<h3 id="一、核心概念"><a href="#一、核心概念" class="headerlink" title="一、核心概念"></a><strong>一、核心概念</strong></h3><ol>
<li><strong>节点角色</strong>：<ul>
<li><strong>领导者（Leader）</strong>：唯一处理客户端请求的节点，负责日志同步。</li>
<li><strong>跟随者（Follower）</strong>：被动接收领导者的日志条目和心跳。</li>
<li><strong>候选人（Candidate）</strong>：选举过程中的临时角色，尝试成为领导者。</li>
</ul>
</li>
<li><strong>任期（Term）</strong>：<ul>
<li>全局单调递增的编号，标识逻辑时间区间。</li>
<li>每个任期以一次选举开始，可能选举出领导者或失败后进入新任期。</li>
</ul>
</li>
<li><strong>RPC通信</strong>：<ul>
<li><strong>请求投票（RequestVote）</strong>：候选人发起选举时调用。</li>
<li><strong>追加条目（AppendEntries）</strong>：领导者发送日志条目或心跳。</li>
</ul>
</li>
</ol>
<h3 id="二、领导者选举"><a href="#二、领导者选举" class="headerlink" title="二、领导者选举"></a><strong>二、领导者选举</strong></h3><h4 id="1-触发条件"><a href="#1-触发条件" class="headerlink" title="1. 触发条件"></a><strong>1. 触发条件</strong></h4><ul>
<li>跟随者若在**选举超时时间（Election Timeout，通常150-300ms）**内未收到领导者心跳，则转变为候选人，发起新选举。</li>
</ul>
<h4 id="2-选举流程"><a href="#2-选举流程" class="headerlink" title="2. 选举流程"></a><strong>2. 选举流程</strong></h4><ol>
<li><strong>自增任期号</strong>：候选人将当前任期号加1。</li>
<li><strong>发起投票请求</strong>：向其他节点发送<code>RequestVote</code> RPC，包含：<ul>
<li>候选人任期号。</li>
<li>候选人最后一条日志的索引和任期号。</li>
</ul>
</li>
<li><strong>投票规则</strong>：<ul>
<li>每个节点每任期最多投一票（先到先得）。</li>
<li>仅当候选人的日志至少与自己一样新时，才会投票。</li>
</ul>
</li>
<li><strong>选举结果</strong>：<ul>
<li><strong>成功</strong>：候选人获得**多数派（N&#x2F;2+1）**投票，成为领导者。</li>
<li><strong>失败</strong>：其他节点成为领导者，或选举超时后重新发起选举。</li>
</ul>
</li>
</ol>
<h4 id="3-避免选举冲突"><a href="#3-避免选举冲突" class="headerlink" title="3. 避免选举冲突"></a><strong>3. 避免选举冲突</strong></h4><ul>
<li><strong>随机化选举超时</strong>：减少多个候选人同时竞争的可能性。</li>
<li><strong>心跳压制</strong>：候选人收到更高任期的领导者心跳时，退回为跟随者。</li>
</ul>
<h3 id="三、日志复制"><a href="#三、日志复制" class="headerlink" title="三、日志复制"></a><strong>三、日志复制</strong></h3><h4 id="1-日志结构"><a href="#1-日志结构" class="headerlink" title="1. 日志结构"></a><strong>1. 日志结构</strong></h4><ul>
<li>每个日志条目包含：<ul>
<li><strong>索引（Index）</strong>：日志位置编号。</li>
<li><strong>任期号（Term）</strong>：创建该条目的领导者任期。</li>
<li><strong>命令（Command）</strong>：客户端请求的操作。</li>
</ul>
</li>
</ul>
<h4 id="2-日志复制流程"><a href="#2-日志复制流程" class="headerlink" title="2. 日志复制流程"></a><strong>2. 日志复制流程</strong></h4><ol>
<li><strong>客户端请求</strong>：领导者接收请求，将命令追加到本地日志。</li>
<li><strong>并行复制</strong>：领导者向所有跟随者发送<code>AppendEntries</code> RPC，包含：<ul>
<li>前一条日志的索引和任期号（用于一致性检查）。</li>
<li>新日志条目。</li>
</ul>
</li>
<li><strong>跟随者确认</strong>：<ul>
<li>若跟随者的日志与前一条匹配，则追加新条目并返回成功。</li>
<li>否则拒绝，领导者回溯日志并重试。</li>
</ul>
</li>
<li><strong>提交日志</strong>：<ul>
<li>当新条目被<strong>多数派</strong>复制后，领导者提交该条目（应用到状态机）。</li>
<li>通知跟随者提交（通过后续<code>AppendEntries</code>心跳）。</li>
</ul>
</li>
</ol>
<h4 id="3-日志一致性保证"><a href="#3-日志一致性保证" class="headerlink" title="3. 日志一致性保证"></a><strong>3. 日志一致性保证</strong></h4><ul>
<li><strong>日志匹配特性</strong>：<ul>
<li>若两个日志条目具有相同的索引和任期号，则内容相同。</li>
<li>若某条目在某个日志中存在，则其之前的所有条目也必须存在。</li>
</ul>
</li>
<li><strong>领导者强制覆盖</strong>：领导者通过一致性检查，覆盖跟随者不一致的日志。</li>
</ul>
<h3 id="四、安全性"><a href="#四、安全性" class="headerlink" title="四、安全性"></a><strong>四、安全性</strong></h3><h4 id="1-选举限制（Election-Restriction）"><a href="#1-选举限制（Election-Restriction）" class="headerlink" title="1. 选举限制（Election Restriction）"></a><strong>1. 选举限制（Election Restriction）</strong></h4><ul>
<li>只有拥有<strong>最新日志</strong>的节点才能成为领导者：<ul>
<li>比较候选人与投票者日志的最后一个条目的任期号。</li>
<li>若任期号相同，则比较日志索引。</li>
</ul>
</li>
</ul>
<h4 id="2-提交规则（Commitment-Rules）"><a href="#2-提交规则（Commitment-Rules）" class="headerlink" title="2. 提交规则（Commitment Rules）"></a><strong>2. 提交规则（Commitment Rules）</strong></h4><ul>
<li>领导者只能提交<strong>当前任期</strong>的日志条目。</li>
<li>之前任期的条目仅在被多数派复制且当前任期有提交时，才可间接提交。</li>
</ul>
<h4 id="3-脑裂（Split-Brain）处理"><a href="#3-脑裂（Split-Brain）处理" class="headerlink" title="3. 脑裂（Split-Brain）处理"></a><strong>3. 脑裂（Split-Brain）处理</strong></h4><ul>
<li>网络分区时，仅多数派分区可选举新领导者，少数派分区因无法获得多数投票而阻塞。</li>
</ul>
<h3 id="五、示例"><a href="#五、示例" class="headerlink" title="五、示例"></a>五、示例</h3><ul>
<li>假设此时分布式系统中有三个节点，最初始都处于追随者状态，由于没有听到领导者的心跳，那么他们就可以成为候选人。</li>
</ul>
<p><img src="C:\Users\likuan\AppData\Roaming\Typora\typora-user-images\image-20250409145153304.png" alt="image-20250409145153304"></p>
<ul>
<li><p>接着候选人会向其它节点请求投票</p>
<p><img src="C:\Users\likuan\AppData\Roaming\Typora\typora-user-images\image-20250409145622561.png" alt="image-20250409145622561"></p>
</li>
<li><p>其他节点做出回应，如果候选人得到大多数节点的投票，则成为领导者。现在，系统中的所有变更都需要经过领导者。</p>
<p><img src="C:\Users\likuan\AppData\Roaming\Typora\typora-user-images\image-20250409145827856.png" alt="image-20250409145827856"></p>
</li>
<li><p>每一个更改都会作为条目添加在节点的日志中，该日志条目当前未提交，因此不会更新节点的值。</p>
</li>
</ul>
<p><img src="C:\Users\likuan\AppData\Roaming\Typora\typora-user-images\image-20250409150109396.png" alt="image-20250409150109396"></p>
<ul>
<li><p>为了提交条目，节点首先将其复制到跟随节点。然后领导等待，直到大多数节点都写入了该条目。</p>
<p><img src="C:\Users\likuan\AppData\Roaming\Typora\typora-user-images\image-20250409150348833.png" alt="image-20250409150348833"></p>
</li>
<li><p>然后条目已在领导节点提交，状态为5。也就是说领导节点需要等待大多数跟随者的回应。</p>
<p><img src="C:\Users\likuan\AppData\Roaming\Typora\typora-user-images\image-20250409150648336.png" alt="image-20250409150648336"></p>
</li>
<li><p>然后领导者通知追随者该条目已经提交，集群现在已经达成共识。这个过程称为日志复制。</p>
<p><img src="C:\Users\likuan\AppData\Roaming\Typora\typora-user-images\image-20250409150751649.png" alt="image-20250409150751649"></p>
</li>
</ul>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 2681123650@qq.com </span>
    </div>
</article>







    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©有志者，事竟成
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="Toggle full screen shortcut key s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    
    #post .pjax article .article-entry>ol, #post .pjax article .article-entry>ul, #post .pjax article>ol, #post .pjax article>ul{
        border: #e2dede solid 1px;
        border-radius: 10px;
        padding: 10px 32px 10px 56px;
    }
    #post .pjax article .article-entry li>ol, #post .pjax article .article-entry li>ul,#post .pjax article li>ol, #post .pjax article li>ul{
        padding-top: 5px;
        padding-bottom: 5px;
    }
    #post .pjax article .article-entry>ol>li, #post .pjax article .article-entry>ul>li,#post .pjax article>ol>li, #post .pjax article>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    #post .pjax article .article-entry li>ol>li, #post .pjax article .article-entry li>ul>li,#post .pjax article li>ol>li, #post .pjax article li>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.3;
        background: url("https://i.loli.net/2019/07/22/5d3521411f3f169375.png");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
</style>







</html>
